version: '3'

services:
  
  node-master:
    build:
      context: .
      dockerfile: ./master/Dockerfile
    container_name: master-node
    hostname: node-master
    networks:
      cluster:
        ipv4_address: 192.1.0.2
    depends_on:
      - node1
      - node2
    extra_hosts:
      - "node1:192.1.0.3"
      - "node2:192.1.0.4"

  node1:
    build:
      context: .
      dockerfile: ./nodes/Dockerfile
    image: worker-node
    container_name: data-node1
    hostname: node1
    networks:
      cluster:
        ipv4_address: 192.1.0.3
    extra_hosts:
      - "node-master:192.1.0.2"
      - "node2:192.1.0.4"

  node2:
    image: worker-node
    container_name: data-node2
    hostname: node2
    networks:
      cluster:
        ipv4_address: 192.1.0.4
    extra_hosts:
      - "node-master:192.1.0.2"
      - "node1:192.1.0.2"
    depends_on: 
      - node1
      
  database:
      image: mysql:5.7
      hostname: database
      container_name: mysql
      networks:
        cluster:
          ipv4_address: 192.1.0.5
      ports:
          - "3306:3306"
      command: --init-file /data/application/init.sql
      volumes:
          - ./hue/init.sql:/data/application/init.sql
      environment:
          MYSQL_ROOT_USER: root
          MYSQL_ROOT_PASSWORD: secret
          MYSQL_DATABASE: hue
          MYSQL_USER: root
          MYSQL_PASSWORD: secret

  hue:
      image: gethue/hue:latest
      hostname: hue
      container_name: hue_
      dns: 8.8.8.8
      command: /bin/bash /opt/run-hue-when-database-up.sh
      networks:
        cluster:
          ipv4_address: 192.1.0.6
      ports:
      - "8888:8888"
      volumes:
        - ./hue/conf/hue-overrides.ini:/usr/share/hue/desktop/conf/z-hue.ini
        - ./hue/connection-test.py:/opt/connection-test.py
        - ./hue/run-hue-when-database-up.sh:/opt/run-hue-when-database-up.sh
      depends_on:
        - "database"
        - "node-master"
        - "node1"
        - "node2"
      extra_hosts:
        - "database:192.1.0.5"
        - "node-master:192.1.0.2"



networks:
  cluster:
    driver: bridge
    ipam:
      config:
        - subnet: 192.1.0.0/16
